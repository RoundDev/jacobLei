<script
  type="text/javascript"
  src="https://sandbox.web.squarecdn.com/v1/square.js"
></script>
<script>
  const appId = 'sandbox-sq0idp-par5NbRuDfbBOcgNv5j3sw';
  const locationId = 'CBASEDepGeN6Eev-N-FYE90UA1sgAQ';

  async function initializeCard(payments) {
    const card = await payments.card();
    await card.attach('#card-container');

    return card;
  }

  async function createPayment(token) {
    const body = JSON.stringify({
      locationId,
      sourceId: token,
    });

    const paymentResponse = await fetch('/payment', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body,
    });

    if (paymentResponse.ok) {
      return paymentResponse.json();
    }

    const errorBody = await paymentResponse.text();
    throw new Error(errorBody);
  }

  async function tokenize(paymentMethod) {
    const tokenResult = await paymentMethod.tokenize();
    if (tokenResult.status === 'OK') {
      return tokenResult.token;
    } else {
      let errorMessage = `Tokenization failed with status: ${tokenResult.status}`;
      if (tokenResult.errors) {
        errorMessage += ` and errors: ${JSON.stringify(
          tokenResult.errors
        )}`;
      }

      throw new Error(errorMessage);
    }
  }

  // status is either SUCCESS or FAILURE;
  function displayPaymentResults(status) {
    const statusContainer = document.getElementById(
      'payment-status-container'
    );
    if (status === 'SUCCESS') {
      statusContainer.classList.remove('is-failure');
      statusContainer.classList.add('is-success');
    } else {
      statusContainer.classList.remove('is-success');
      statusContainer.classList.add('is-failure');
    }

    statusContainer.style.visibility = 'visible';
  }

  document.addEventListener('DOMContentLoaded', async function () {
    if (!window.Square) {
      throw new Error('Square.js failed to load properly');
    }

    let payments;
    try {
      payments = window.Square.payments(appId, locationId);
    } catch {
      const statusContainer = document.getElementById(
        'payment-status-container'
      );
      statusContainer.className = 'missing-credentials';
      statusContainer.style.visibility = 'visible';
      return;
    }

    let card;
    try {
      card = await initializeCard(payments);
    } catch (e) {
      console.error('Initializing Card failed', e);
      return;
    }

    // Checkpoint 2.
    async function handlePaymentMethodSubmission(event, paymentMethod) {
      event.preventDefault();

      try {
        // disable the submit button as we await tokenization and make a payment request.
        cardButton.disabled = true;
        const token = await tokenize(paymentMethod);
        const paymentResults = await createPayment(token);
        displayPaymentResults('SUCCESS');

        console.debug('Payment Success', paymentResults);
      } catch (e) {
        cardButton.disabled = false;
        displayPaymentResults('FAILURE');
        console.error(e.message);
      }
    }

    const cardButton = document.getElementById('payButton');
    cardButton.addEventListener('click', async function (event) {
      await handlePaymentMethodSubmission(event, card);
    });
  });
</script>

<div class="container bg-1 padding-container">
<div id="sq-ccbox">
  <form [formGroup]="infoPaymentForm" id="nonce-form"  method="POST">
    <input type="hidden" name="action" value="/api/sendpayment"/>
  <div class="row row-padding padding-content md-padding-content lg-padding-content">
    <div class="col-12"></div>
    <div class="panel panel-info">
      <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6  panel-heading">
        <div class= "col-xs-12 col-sm-12 col-md-6 col-lg-6"><span><i class="glyphicon glyphicon-lock"></i></span> Secure Payment
        </div>
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 pull-right"><img class="pull-right cards-img" src="assets/img/credit-cards.png">
        </div>
      </div>

      <div class="panel-body panel-box">
        <div class="form-group" >
          <div class="col-sm-12 col-md-12">
            <label for="first_name">First Name on Card (Required)</label>
            <input id="first_name" formControlName="given_name" autocomplete="off" type="text"  (input)="checkInputError()" class="form-control" name="first_name" required/>
<!--            <span class="alert-warning small" *ngIf="firstNameError !== null">{{firstNameError}}<br></span>-->
<!--            <span class="note"> *Field Cannot Be Left Blank</span>-->
          </div>
        </div>
        <div class="form-group" >
          <div class="col-sm-12 col-md-12">
            <label for="last_name">Last Name on Card (Required)</label>
            <input id="last_name" formControlName="family_name" autocomplete="off" type="text"  (input)="checkInputError()" class="form-control" name="last_name" required/>
<!--            <span class="alert-warning small" *ngIf="lastNameError !== null">{{lastNameError}}<br></span>-->
<!--            <span class="note"> *Field Cannot Be Left Blank</span>-->
          </div>
        </div>
        <div class="form-group">
          <div class="col-sm-12 col-md-12 col-lg-12">
            <label for="phone_number">Phone Number (Required)</label>
            <input id="phone_number" formControlName="phone_number" autocomplete="off" (input)="checkInputError()"  [textMask]="{mask: mask}" [(ngModel)]="phoneNumberModel" type="text" class="form-control" name="phone_number" required/>
<!--            <span class="alert-warning small" *ngIf="phoneNumberError !== null">{{phoneNumberError}}<br></span>-->
<!--            <span class="note"> *Field Cannot Be Left Blank</span>-->
          </div>
        </div>
        <div class="form-group">
          <div class="col-sm-12 col-md-12 col-lg-12">
            <label for="email_address">Email Address (Required)</label>
            <input id="email_address" formControlName="email_address" autocomplete="off" (input)="checkInputError()"  type="text" class="form-control" name="email_address" required/>
<!--            <span class="alert-warning small" *ngIf="emailError !== null">{{emailError}}<br></span>-->
<!--            <span class="note"> *Field Cannot Be Left Blank</span>-->
          </div>
        </div>
        <!--Beginning of Square-->

        <div>
          <div class="form-group">
            <div class="col-sm-12 col-md-12 col-lg-12">
            <label for="sq-card-number">Card Number (Required)</label>
              <input id="sq-card-number"  placeholder="•••• •••• •••• ••••" class="form-control"/>
<!--              <span class="note"> *Field Cannot Be Left Blank</span>-->
            </div>
          </div>
          <div class="form-group">
            <div class="col-xss-12 col-sm-12 col-md-12 col-lg-12">
            <label for="sq-expiration-date">Expiration Date (Required)</label>
              <input id="sq-expiration-date" placeholder="MM/YY" class="form-control"/>
<!--              <span class="note"> *Field Cannot Be Left Blank</span>-->
            </div>
          </div>
          <div class="form-group clearfix">
            <div class='col-xs-12 col-md-12 col-lg-12'>
            <label for="sq-cvv">Card CVV (Required)</label>
              <input id="sq-cvv" placeholder="CVV"  class="form-control"/>
<!--              <span class="note"> *Field Cannot Be Left Blank</span>-->
              <span class="afix">3 Digit Security Code on Back or 4 Digits on Front of AmEx</span>
            </div>
          </div>
          <div class="form-group clearfix">
            <div class='col-xs-12 col-md-12 col-lg-12'>
            <label for="sq-postal-code">5 Digit Card Zip Code (Required)</label>
              <input id="sq-postal-code" placeholder="54321"  class="form-control"/>
<!--              <span class="note"> *Field Cannot Be Left Blank</span>-->
              <span class="afix">5 Digit Credit Card Zip Code</span>
            </div>
          </div>
          <div id="error"></div>
        </div>

        <!--End of Square payment-->

        <div class="form-group clearfix">
          <div class="col-sm-12 col-md-12 col-lg-12">
            <label for="property_name">Rental Property Address (Required)</label>
              <input id="property_name" formControlName="property_name"   (input)="checkInputError()" type="text" class="form-control" name="property_name" required/>
<!--            <span class="alert-warning small" *ngIf="propertyNameError !== null">{{propertyNameError}}<br></span>-->
<!--            <span class="note"> *Field Cannot Be Left Blank</span>-->
          </div>
        </div>
        <div class="form-group">
          <div class="col-sm-12 col-md-12 col-lg-12">
            <label for="differentName">Are You Paying for Yourself or Someone Else, Please Enter Name (Required)</label>
            <input id="differentName" autocomplete="off" formControlName="differentName"  (input)="checkInputError()" type="text" class="form-control" name="differentName"  required/>
<!--            <span class="alert-warning small" *ngIf="differentNameError !== null">{{differentNameError}}<br></span>-->
<!--            <span class="note"> *Field Cannot Be Left Blank</span>-->
          </div>
        </div>
        <div class="form-group">
          <div class="col-sm-6 col-md-6 col-lg-6">
            <label for="amountToPay">Amount You Are Paying (Required)</label>
            <span class="currency-input">$</span><input id="amountToPay" formControlName="amountToPay"  (input)="checkInputError()" autocomplete="off" type="number" min="1" max="9999" class="form-control" name="amountToPay"  value="0" />
            <span class="alert-warning small" *ngIf="amountToPayError !== null">{{amountToPayError}}<br></span>
<!--            <span class="note"> *Field Cannot Be Left Blank</span>-->
            <span class="afix">***3.75% fee will be added to the amount (see below)</span>
          </div>
        </div>
        <div class="form-group">
          <div class="col-xs-12 col-md-12 col-sm-12 col-xs-12 col-lg-12 pull-right btn-row">
            <button id="sq-creditcard"  class="btn btn-primary btn-lg btn-submit-fix pull-right" [disabled]="!infoPaymentForm.valid" data-toggle="modal" data-target="#modalConformation" (click)="conformationModal();" >Pay</button>
            <input type="hidden" id="sq-id" name="sq-id">
            <input type="hidden" id="card-nonce" name="nonce">
            <!--<input type="hidden" id="amountWithFee" name="amountWithFee" value="{{totalAmount}}">-->
            <!--(click)="requestCardNonce($event)"-->
          </div>
          <div class="col-xs-12 col-md-6 col-sm-6 col-xs-6 col-lg-6 pull-right">
          </div>
        </div>
        <div class="form-group">
          <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <p class="alert alert-info info-p">
              ***3.75% fee added as a transaction processing fee charged by the merchant account provider***
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  </form>
</div>
</div>
<!--Modal-->
<div class="modal fade" id="modalConformation">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3 *ngIf="conformationShow" class="modal-title">{{modalHeader}}</h3>
        <h3 *ngIf="paymnetSuccess" class="modal-title">{{modalHeader}}</h3>
        <!--<h3 *ngIf="paymnetSuccess === false" class="modal-title">{{modalHeader}}</h3>-->
      </div>
      <div class="modal-body">
        <h5 *ngIf="conformationShow">${{modalAmountToPay}}</h5>
        <h5 *ngIf="paymnetSuccess">{{modalConformation}}</h5>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-default" id="payButton"  data-target="#modal" >Pay</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
